<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion 1</title>
  <style>
    :root{
      --track-h: 120px;
      --ball-d: 28px;
      --tick-step: 10px;
      --major-step: 100px;
      --panel-h: 45vh; /* NEW: data panel height */
    }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b0c10; color:#eaf0f7}
    body.panel-open { padding-bottom: var(--panel-h); } /* NEW: keep content visible when panel open */

    header{padding:16px 20px; border-bottom:1px solid #222; display:flex; gap:12px; align-items:end; flex-wrap:wrap}
    header h1{font-size:1.1rem; margin:0; letter-spacing:.2px; color:#cfe4ff}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{background:#11161d; color:#eaf0f7; border:1px solid #2a3542; padding:8px 12px; border-radius:10px; font-size:.95rem; cursor:pointer}
    button:hover{background:#18202a}
    button:disabled{opacity:.5; cursor:not-allowed}
    .readout{margin-left:auto; display:flex; gap:24px; align-items:center}
    .chip{background:#0f1722; border:1px solid #253344; padding:6px 10px; border-radius:999px; font-variant-numeric: tabular-nums}

    .stage-wrap{padding:20px}
    .stage{position:relative; height: var(--track-h); border:1px solid #1f2a36; border-radius:16px; background:linear-gradient(180deg,#0e131a,#0b1016); overflow:hidden}

    .label{position:absolute; top:8px; font-size:.9rem; color:#9ab3cc}
    .label.a{left:10px}
    .label.b{right:10px}

    .measure{position:absolute; left:0; right:0; bottom:22px; height:40px}
    .baseline{position:absolute; left:0; right:0; top:20px; height:2px; background:#2a3542}
    .ticks{position:absolute; left:0; right:0; top:0; height:100%}
    .tick{position:absolute; width:1px; background:#4b5d74; bottom:20px}
    .tick.minor{height:10px}
    .tick.major{height:16px; background:#8fb6dd}
    .tick-label{position:absolute; bottom:0; transform:translateX(-50%); font-size:.75rem; color:#9ab3cc}

    .ball{position:absolute; width:var(--ball-d); height:var(--ball-d); border-radius:50%; top: calc(50% - var(--ball-d)/2 + 8px); background: radial-gradient(circle at 30% 30%, #cfe4ff, #5ea0ff 55%, #2d4f87); box-shadow: 0 10px 20px rgba(94,160,255,.25)}

    .footer{padding:10px 20px 24px; color:#98a9bd; font-size:.9rem}
    .note{opacity:.85}

    /* NEW: bottom data panel */
    .data-panel{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--panel-h);
      background: linear-gradient(180deg,#0e131a,#0a0d12);
      border-top: 1px solid #1f2a36;
      display: none;
      grid-template-rows: auto 1fr;
      z-index: 50;
    }
    .data-panel.show { display: grid; }
    .data-head{
      display:flex; align-items:center; gap:10px;
      padding:10px 16px; border-bottom:1px solid #1f2a36;
      font-size:.95rem; color:#cfe4ff;
    }
    .data-info{margin-left:auto; font-size:.9rem; color:#9ab3cc}
    .data-body{overflow:auto}
    table{
      width:100%; border-collapse: collapse; font-variant-numeric: tabular-nums;
    }
    thead th{
      position: sticky; top:0; background:#0f1722; color:#cfe4ff; text-align:left;
      border-bottom:1px solid #1f2a36; padding:8px 12px;
    }
    tbody td{
      border-bottom:1px solid #15202c; padding:8px 12px; color:#eaf0f7;
    }
    .spacer{flex:1}
  </style>
</head>
<body>
  <header>
    <h1>Motion 1</h1>
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="pauseBtn" disabled>Pause</button>
      <button id="resumeBtn" disabled>Resume</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="resetBtn" disabled>Reset</button>
      <button id="tableBtn">Data Table</button> <!-- NEW -->
      <button id="downloadBtn" disabled>Download CSV</button> <!-- NEW -->
    </div>
    <div class="readout">
      <div class="chip">t = <span id="tOut">0.00</span> s</div>
      <div class="chip">x = <span id="xOut">0.00</span> m</div>
    </div>
  </header>

  <div class="stage-wrap">
    <div class="stage" id="stage">
      <div class="label a">Point A</div>
      <div class="label b">Point B</div>

      <div class="measure">
        <div class="baseline"></div>
        <div class="ticks" id="ticks"></div>
      </div>

      <div class="ball" id="ball" aria-label="moving ball"></div>
    </div>
  </div>

  <!-- NEW: bottom data panel -->
  <section id="dataPanel" class="data-panel" aria-live="polite">
    <div class="data-head">
      <strong>Data Table</strong>
      <span class="spacer"></span>
      <span id="dataInfo" class="data-info">â€”</span>
    </div>
    <div class="data-body">
      <table aria-label="time and position data">
        <thead>
          <tr><th>t (s)</th><th>x (m)</th></tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
  </section>

  <div class="footer">
    <div class="note">Describe and quantify the motion of the ball</div>
  </div>

  <script>
    const stage = document.getElementById('stage');
    const ball = document.getElementById('ball');
    const ticksEl = document.getElementById('ticks');

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');

    const tableBtn = document.getElementById('tableBtn');          // NEW
    const downloadBtn = document.getElementById('downloadBtn');    // NEW
    const dataPanel = document.getElementById('dataPanel');        // NEW
    const dataBody = document.getElementById('dataBody');          // NEW
    const dataInfo = document.getElementById('dataInfo');          // NEW

    const tOut = document.getElementById('tOut');
    const xOut = document.getElementById('xOut');

    let a = 3.25; // fixed acceleration in px/s^2
    let running = false;
    let paused = false;
    let startTime = 0;
    let elapsed = 0;
    let rafId = null;
    let ballOffset = parseFloat(getComputedStyle(ball).width)/2;

    // NEW: table capture state
    let tableEnabled = false;
    let tableEndTime = 0;
    let tableDt = 0;
    let nextSampleTime = 0;
    let dataRows = [];

    function buildTicks(){
      const minor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tick-step')) || 10;
      const major = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--major-step')) || 100;
      const width = stage.clientWidth;
      ticksEl.innerHTML = '';
      for(let x=0; x<=width; x+=minor){
        const isMajor = (x % major === 0);
        const tick = document.createElement('div');
        tick.className = 'tick ' + (isMajor ? 'major' : 'minor');
        tick.style.left = x + 'px';
        ticksEl.appendChild(tick);
        if(isMajor){
          const label = document.createElement('div');
          label.className = 'tick-label';
          label.textContent = (x/major).toString();
          label.style.left = x + 'px';
          ticksEl.appendChild(label);
        }
      }
    }

    function formatTime(sec){
      return (Math.round(sec * 100) / 100).toFixed(3);
    }
    function formatMeters(px){ return (px/100).toFixed(3); }

    function xAt(t){ return 0.5 * a * t * t; } // px

    function setX(px){
      ball.style.transform = `translateX(${px - ballOffset}px)`;
      xOut.textContent = formatMeters(px);
    }

    function updateReadouts(t, x){
      tOut.textContent = formatTime(t);
      xOut.textContent = formatMeters(x);
    }

    // NEW: table helpers
    function showPanel(){
      dataPanel.classList.add('show');
      document.body.classList.add('panel-open');
    }
    function hidePanel(){
      dataPanel.classList.remove('show');
      document.body.classList.remove('panel-open');
    }
    function clearTable(){
      dataRows = [];
      dataBody.innerHTML = '';
      downloadBtn.disabled = true;
    }
    function appendRow(t, xPx){
      const tr = document.createElement('tr');
      const tdT = document.createElement('td');
      const tdX = document.createElement('td');
      tdT.textContent = formatTime(t);
      tdX.textContent = formatMeters(xPx);
      tr.appendChild(tdT); tr.appendChild(tdX);
      dataBody.appendChild(tr);
      dataRows.push({ t: t, x_m: xPx/100 });
      downloadBtn.disabled = dataRows.length === 0;
    }

    function step(now){
      if(!running){ return; }
      if(paused){ rafId = requestAnimationFrame(step); return; }

      let t = (now - startTime) / 1000 + elapsed;
      let x = xAt(t);
      setX(x);
      updateReadouts(t, x);

      // NEW: live sampling & end-time enforcement
      if(tableEnabled){
        // fill rows at exact multiples of tableDt using model x(t)
        while (t + 1e-9 >= nextSampleTime && nextSampleTime <= tableEndTime + 1e-9){
          appendRow(nextSampleTime, xAt(nextSampleTime));
          nextSampleTime = +(nextSampleTime + tableDt).toFixed(10); // avoid FP drift
        }
        // if we've reached/exceeded end time, snap to end, pause, and ensure last row consistency
        if(t >= tableEndTime - 1e-9){
          const xEnd = xAt(tableEndTime);
          setX(xEnd);
          updateReadouts(tableEndTime, xEnd);
          // ensure the final sample equals end time exactly (if not already added due to rounding)
          const last = dataRows[dataRows.length - 1];
          if(!last || Math.abs(last.t - tableEndTime) > 1e-6){
            appendRow(tableEndTime, xEnd);
          }
          // freeze the timeline exactly at end
          const tNow = performance.now();
          elapsed = tableEndTime; // lock elapsed to end time
          paused = true;
          toggleButtons('paused');
          rafId = requestAnimationFrame(step);
          return;
        }
      }

      rafId = requestAnimationFrame(step);
    }

    function toggleButtons(state){
      if(state === 'idle'){
        startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = true;
      } else if(state === 'running'){
        startBtn.disabled = true; pauseBtn.disabled = false; resumeBtn.disabled = true; stopBtn.disabled = false; resetBtn.disabled = false;
      } else if(state === 'paused'){
        startBtn.disabled = true; pauseBtn.disabled = true; resumeBtn.disabled = false; stopBtn.disabled = false; resetBtn.disabled = false;
      } else if(state === 'stopped'){
        startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = false;
      }
    }

    startBtn.addEventListener('click', () => {
      cancelAnimationFrame(rafId);
      running = true; paused = false; elapsed = 0;
      setX(0);
      updateReadouts(0, 0);
      // NEW: (re)initialize sampling plan at run start
      if(tableEnabled){
        clearTable();
        nextSampleTime = 0;
      }
      startTime = performance.now();
      toggleButtons('running');
      rafId = requestAnimationFrame(step);
    });

    pauseBtn.addEventListener('click', () => {
      if(!running || paused) return;
      const tNow = performance.now();
      elapsed += (tNow - startTime) / 1000;
      paused = true;
      toggleButtons('paused');
    });

    resumeBtn.addEventListener('click', () => {
      if(!running || !paused) return;
      // If table is enabled and we already hit the end-time, prevent resume beyond it
      if(tableEnabled && elapsed >= tableEndTime - 1e-9){
        return; // stay paused at end to remain consistent with the table
      }
      paused = false;
      startTime = performance.now();
      toggleButtons('running');
      rafId = requestAnimationFrame(step);
    });

    stopBtn.addEventListener('click', () => {
      if(!running) return;
      running = false; paused = false;
      toggleButtons('stopped');
      cancelAnimationFrame(rafId);
      // keep table visible; user can still download CSV
    });

    resetBtn.addEventListener('click', () => {
      running = false; paused = false; elapsed = 0;
      cancelAnimationFrame(rafId);
      setX(0);
      updateReadouts(0,0);
      toggleButtons('idle');
      // NEW: clear table but keep panel open if enabled
      if(tableEnabled){ clearTable(); nextSampleTime = 0; }
    });

    // NEW: Data Table button â†’ prompt for end-time & increment
    tableBtn.addEventListener('click', () => {
      // Get inputs
      let T = prompt("End time (s):", "5");
      if(T === null) return; // cancelled
      let dt = prompt("Time increment Î”t (s):", "0.2");
      if(dt === null) return;

      T = Number(T);
      dt = Number(dt);

      if(!(isFinite(T) && T > 0)){
        alert("Please enter a positive end time.");
        return;
      }
      if(!(isFinite(dt) && dt > 0 && dt <= T)){
        alert("Please enter a positive increment less than or equal to the end time.");
        return;
      }

      tableEnabled = true;
      tableEndTime = T;
      tableDt = dt;
      nextSampleTime = 0;
      clearTable();
      showPanel();
      dataInfo.textContent = `End: ${formatTime(tableEndTime)} s, Î”t: ${formatTime(tableDt)} s`;

      // If we're currently running from some elapsed > 0 (e.g., user turned on mid-run),
      // restart so sampling aligns from t=0
      if(running){
        // restart run to align timeline with table
        running = false; paused = false; elapsed = 0;
        setX(0); updateReadouts(0,0);
        cancelAnimationFrame(rafId);
        running = true; paused = false;
        startTime = performance.now();
        toggleButtons('running');
        rafId = requestAnimationFrame(step);
      }
    });

    // NEW: CSV download
    downloadBtn.addEventListener('click', () => {
      if(dataRows.length === 0) return;
      const lines = [["time (s)","x (m)"], ...dataRows.map(r => [r.t.toFixed(3), r.x_m.toFixed(3)])];
      const csv = lines.map(row => row.join(",")).join("\n");
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "motion_data.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    window.addEventListener('resize', buildTicks);
    setX(0);
    buildTicks();
    toggleButtons('idle');
  </script>
</body>
</html>
