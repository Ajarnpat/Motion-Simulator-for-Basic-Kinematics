<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion 4</title>
  <style>
    :root{
      --track-h: 120px;
      --ball-d: 28px;
      --tick-step: 10px;
      --major-step: 100px;
      --panel-h: 45vh; /* data panel height */
    }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b0c10; color:#eaf0f7}
    body.panel-open { padding-bottom: var(--panel-h); }

    header{padding:16px 20px; border-bottom:1px solid #222; display:flex; gap:12px; align-items:end; flex-wrap:wrap}
    header h1{font-size:1.1rem; margin:0; letter-spacing:.2px; color:#cfe4ff}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{background:#11161d; color:#eaf0f7; border:1px solid #2a3542; padding:8px 12px; border-radius:10px; font-size:.95rem; cursor:pointer}
    button:hover{background:#18202a}
    button:disabled{opacity:.5; cursor:not-allowed}
    .readout{margin-left:auto; display:flex; gap:24px; align-items:center}
    .chip{background:#0f1722; border:1px solid #253344; padding:6px 10px; border-radius:999px; font-variant-numeric: tabular-nums}

    .stage-wrap{padding:20px}
    .stage{position:relative; height: var(--track-h); border:1px solid #1f2a36; border-radius:16px; background:linear-gradient(180deg,#0e131a,#0b1016); overflow:hidden}

    .label{position:absolute; top:8px; font-size:.9rem; color:#9ab3cc}
    .label.a{left:10px}
    .label.b{right:10px}

    .measure{position:absolute; left:0; right:0; bottom:22px; height:40px}
    .baseline{position:absolute; left:0; right:0; top:20px; height:2px; background:#2a3542}
    .ticks{position:absolute; left:0; right:0; top:0; height:100%}
    .tick{position:absolute; width:1px; background:#4b5d74; bottom:20px}
    .tick.minor{height:10px}
    .tick.major{height:16px; background:#8fb6dd}
    .tick-label{position:absolute; bottom:0; transform:translateX(-50%); font-size:.75rem; color:#9ab3cc}

    .ball{position:absolute; width:var(--ball-d); height:var(--ball-d); border-radius:50%; top: calc(50% - var(--ball-d)/2 + 8px); background: radial-gradient(circle at 30% 30%, #cfe4ff, #5ea0ff 55%, #2d4f87); box-shadow: 0 10px 20px rgba(94,160,255,.25)}

    .footer{padding:10px 20px 24px; color:#98a9bd; font-size:.9rem}
    .note{opacity:.85}

    /* bottom data panel */
    .data-panel{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--panel-h);
      background: linear-gradient(180deg,#0e131a,#0a0d12);
      border-top: 1px solid #1f2a36;
      display: none;
      grid-template-rows: auto 1fr;
      z-index: 50;
    }
    .data-panel.show { display: grid; }
    .data-head{
      display:flex; align-items:center; gap:10px;
      padding:10px 16px; border-bottom:1px solid #1f2a36;
      font-size:.95rem; color:#cfe4ff;
    }
    .data-info{margin-left:auto; font-size:.9rem; color:#9ab3cc}
    .data-body{overflow:auto}
    table{ width:100%; border-collapse: collapse; font-variant-numeric: tabular-nums; }
    thead th{
      position: sticky; top:0; background:#0f1722; color:#cfe4ff; text-align:left;
      border-bottom:1px solid #1f2a36; padding:8px 12px;
    }
    tbody td{
      border-bottom:1px solid #15202c; padding:8px 12px; color:#eaf0f7;
    }
    .spacer{flex:1}

    /* Hide velocity column when .hide-vel is on body */
    body.hide-vel .chip.vel { display:none; }
    body.hide-vel th.th-v,
    body.hide-vel td.td-v { display:none; }
/* FIX: use a fixed track length so everyone's physics matches */
.stage {
  width: 900px;      /* choose 800/900/1000 px and use the same in all Motion files */
  margin: 0 auto;    /* center the track */
}

/* Nice-to-have: allow horizontal scroll on very small screens */
.stage-wrap {
  overflow-x: auto;
}

  </style>
</head>
<body>
  <header>
    <h1>Motion 4</h1>
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="pauseBtn" disabled>Pause</button>
      <button id="resumeBtn" disabled>Resume</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="resetBtn" disabled>Reset</button>
      <button id="tableBtn">Data Table</button>
      <button id="toggleVelBtn">Hide Velocity</button>
      <button id="downloadBtn" disabled>Download CSV</button>
    </div>
    <div class="readout">
      <div class="chip">t = <span id="tOut">-0.500</span> s</div>
      <div class="chip">x = <span id="xOut">0.000</span> m</div>
      <div class="chip vel">v = <span id="vOut">0.000</span> m/s</div>
    </div>
  </header>

  <div class="stage-wrap">
    <div class="stage" id="stage">
      <div class="label a">Point A</div>
      <div class="label b">Point B</div>

      <div class="measure">
        <div class="baseline"></div>
        <div class="ticks" id="ticks"></div>
      </div>

      <div class="ball" id="ball" aria-label="moving ball"></div>
    </div>
  </div>

  <!-- bottom data panel -->
  <section id="dataPanel" class="data-panel" aria-live="polite">
    <div class="data-head">
      <strong>Data Table</strong>
      <span class="spacer"></span>
      <span id="dataInfo" class="data-info">—</span>
    </div>
    <div class="data-body">
      <table aria-label="time, position and velocity data">
        <thead>
          <tr><th>t (s)</th><th>x (m)</th><th class="th-v">v (m/s)</th></tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
  </section>

  <div class="footer">
    <div class="note">Describe and quantify the motion of the ball</div>
  </div>

  <script>
    const stage = document.getElementById('stage');
    const ball = document.getElementById('ball');
    const ticksEl = document.getElementById('ticks');

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');

    const tableBtn = document.getElementById('tableBtn');
    const toggleVelBtn = document.getElementById('toggleVelBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    const dataPanel = document.getElementById('dataPanel');
    const dataBody = document.getElementById('dataBody');
    const dataInfo = document.getElementById('dataInfo');

    const tOut = document.getElementById('tOut');
    const xOut = document.getElementById('xOut');
    const vOut = document.getElementById('vOut');

    const a = -3.25; // px/s^2  (1 m = 100 px)

    let running = false;
    let paused = false;
    let startTime = 0;
    let elapsed = -0.5; // start at −0.50 s so that crossing A happens at t=0
    let rafId = null;

    let ballOffset; // half ball diameter (px)
    let xB;         // center position at B (px)
    let v0;         // velocity at t=0 crossing A (px/s), chosen so v=0 at B
    let tStop;      // time from t=0 to stop at B (s)

    // Data table state (sampling from τ=0 at Point A)
    let tableEnabled = false;
    let tableEndTime = 0;
    let tableDt = 0;
    let nextSampleTime = 0;
    let dataRows = [];

    // Velocity visibility state (true = visible)
    let velocityVisible = true;

    function buildTicks(){
      const minor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tick-step')) || 10;
      const major = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--major-step')) || 100;
      const width = stage.clientWidth;
      ticksEl.innerHTML = '';
      for(let x=0; x<=width; x+=minor){
        const isMajor = (x % major === 0);
        const tick = document.createElement('div');
        tick.className = 'tick ' + (isMajor ? 'major' : 'minor');
        tick.style.left = x + 'px';
        ticksEl.appendChild(tick);
        if(isMajor){
          const label = document.createElement('div');
          label.className = 'tick-label';
          label.textContent = (x/major).toString(); // metres (1 m = 100 px)
          label.style.left = x + 'px';
          ticksEl.appendChild(label);
        }
      }
    }

    // --- Formatting (3 dp) ---
    function formatTime(sec){
      return (Math.round(sec * 1000) / 1000).toFixed(3);
    }
    function formatMeters(px){
      return (px/100).toFixed(3);
    }
    function formatVel(pxPerS){
      return (pxPerS/100).toFixed(3);
    }

    function setCenterX(px){
      ball.style.transform = `translateX(${px - ballOffset}px)`;
      xOut.textContent = formatMeters(px);
    }

    function prepKinematics(){
      ballOffset = parseFloat(getComputedStyle(ball).width)/2;
      xB = stage.clientWidth - ballOffset; // center coordinate at right edge (Point B)
      v0 = Math.sqrt(Math.max(0, -2 * a * xB)); // set v=0 at B
      tStop = -v0 / a; // time from A to momentary rest at B
    }

    function xAt(t){ return v0 * t + 0.5 * a * t * t; }
    function vAt(t){ return v0 + a * t; }

    // --- Data panel helpers ---
    function showPanel(){
      dataPanel.classList.add('show');
      document.body.classList.add('panel-open');
    }
    function clearTable(){
      dataRows = [];
      dataBody.innerHTML = '';
      downloadBtn.disabled = true;
    }
    function appendRow(t, xPx, vPxPerS){
      const tr = document.createElement('tr');
      const tdT = document.createElement('td');
      const tdX = document.createElement('td');
      const tdV = document.createElement('td');
      tdT.textContent = formatTime(t);
      tdX.textContent = formatMeters(xPx);
      tdV.textContent = formatVel(vPxPerS);
      tdV.className = 'td-v';
      tr.append(tdT, tdX, tdV);
      dataBody.appendChild(tr);
      dataRows.push({ t: t, x_m: xPx/100, v_mps: vPxPerS/100 });
      downloadBtn.disabled = dataRows.length === 0;
    }

    function step(now){
      if(!running){ return; }
      if(paused){ rafId = requestAnimationFrame(step); return; }

      const t = (now - startTime) / 1000 + elapsed; // display time (may be negative initially)
      const x = xAt(t);
      const v = vAt(t);
      setCenterX(x);
      tOut.textContent = formatTime(t);
      vOut.textContent = formatVel(v);

      // Live sampling from τ = 0 up to End time
      if(tableEnabled){
        const effectiveT = Math.max(0, t);
        while (nextSampleTime <= tableEndTime + 1e-9 && effectiveT + 1e-9 >= nextSampleTime){
          appendRow(nextSampleTime, xAt(nextSampleTime), vAt(nextSampleTime));
          nextSampleTime = +(nextSampleTime + tableDt).toFixed(10); // mitigate FP drift
        }
        if (effectiveT >= tableEndTime - 1e-9){
          const snapT = tableEndTime;
          const snapX = xAt(snapT);
          const snapV = vAt(snapT);
          const last = dataRows[dataRows.length - 1];
          if(!last || Math.abs(last.t - snapT) > 1e-6){
            appendRow(snapT, snapX, snapV);
          }
          setCenterX(snapX);
          tOut.textContent = formatTime(snapT);
          vOut.textContent = formatVel(snapV);
          elapsed = snapT;  // lock to end time
          paused = true;
          toggleButtons('paused');
          rafId = requestAnimationFrame(step);
          return;
        }
      }

      rafId = requestAnimationFrame(step);
    }

    function toggleButtons(state){
      if(state === 'idle'){
        startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = true;
      } else if(state === 'running'){
        startBtn.disabled = true; pauseBtn.disabled = false; resumeBtn.disabled = true; stopBtn.disabled = false; resetBtn.disabled = false;
      } else if(state === 'paused'){
        startBtn.disabled = true; pauseBtn.disabled = true; resumeBtn.disabled = false; stopBtn.disabled = false; resetBtn.disabled = false;
      } else if(state === 'stopped'){
        startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = false;
      }
    }

    // Controls
    startBtn.addEventListener('click', () => {
      cancelAnimationFrame(rafId);
      prepKinematics();
      running = true; paused = false; elapsed = -0.5; // start at −0.50 s lead-in
      setCenterX(xAt(-0.5));
      tOut.textContent = formatTime(-0.5);
      vOut.textContent = formatVel(vAt(-0.5));

      if(tableEnabled){
        clearTable();
        nextSampleTime = 0; // sample from τ=0
      }

      startTime = performance.now();
      toggleButtons('running');
      rafId = requestAnimationFrame(step);
    });

    pauseBtn.addEventListener('click', () => {
      if(!running || paused) return;
      const tNow = performance.now();
      elapsed += (tNow - startTime) / 1000;
      paused = true;
      toggleButtons('paused');
    });

    resumeBtn.addEventListener('click', () => {
      if(!running || !paused) return;
      // If table is enabled and we've already hit the end time, prevent resume beyond it
      if(tableEnabled && elapsed >= tableEndTime - 1e-9){
        return; // stay paused to match the table
      }
      paused = false;
      startTime = performance.now();
      toggleButtons('running');
      rafId = requestAnimationFrame(step);
    });

    stopBtn.addEventListener('click', () => {
      if(!running) return;
      running = false; paused = false;
      toggleButtons('stopped');
      cancelAnimationFrame(rafId);
      // keep table visible; user can still download CSV
    });

    resetBtn.addEventListener('click', () => {
      running = false; paused = false; elapsed = -0.5;
      cancelAnimationFrame(rafId);
      prepKinematics();
      setCenterX(xAt(-0.5));
      tOut.textContent = formatTime(-0.5);
      vOut.textContent = formatVel(vAt(-0.5));
      toggleButtons('idle');
      if(tableEnabled){ clearTable(); nextSampleTime = 0; }
    });

    // Data Table button → prompt for end-time & increment (relative to τ=0 at A)
    tableBtn.addEventListener('click', () => {
      let T = prompt("End time from A (s):", "4");
      if(T === null) return;
      let dt = prompt("Time increment Δt (s):", "0.2");
      if(dt === null) return;

      T = Number(T);
      dt = Number(dt);

      if(!(isFinite(T) && T > 0)){
        alert("Please enter a positive end time.");
        return;
      }
      if(!(isFinite(dt) && dt > 0 && dt <= T)){
        alert("Please enter a positive increment ≤ end time.");
        return;
      }

      tableEnabled = true;
      tableEndTime = T;
      tableDt = dt;
      nextSampleTime = 0;
      clearTable();
      showPanel();
      dataInfo.textContent = `End: ${formatTime(tableEndTime)} s, Δt: ${formatTime(tableDt)} s (from t = 0 at A)`;

      // If currently running, restart to align sampling from τ=0 cleanly
      if(running){
        running = false; paused = false; elapsed = -0.5;
        cancelAnimationFrame(rafId);
        setCenterX(xAt(-0.5));
        tOut.textContent = formatTime(-0.5);
        vOut.textContent = formatVel(vAt(-0.5));
        running = true; paused = false;
        startTime = performance.now();
        toggleButtons('running');
        rafId = requestAnimationFrame(step);
      }
    });

    // Velocity toggle
    function applyVelocityVisibility(){
      if(velocityVisible){
        document.body.classList.remove('hide-vel');
        toggleVelBtn.textContent = 'Hide Velocity';
      }else{
        document.body.classList.add('hide-vel');
        toggleVelBtn.textContent = 'Show Velocity';
      }
    }
    toggleVelBtn.addEventListener('click', () => {
      velocityVisible = !velocityVisible;
      applyVelocityVisibility();
    });
    applyVelocityVisibility(); // initialize

    // CSV download (respects velocity visibility; 3 dp)
    downloadBtn.addEventListener('click', () => {
      if(dataRows.length === 0) return;
      let headers, rows;
      if(velocityVisible){
        headers = ["time (s)","x (m)","v (m/s)"];
        rows = dataRows.map(r => [r.t.toFixed(3), r.x_m.toFixed(3), r.v_mps.toFixed(3)]);
      }else{
        headers = ["time (s)","x (m)"];
        rows = dataRows.map(r => [r.t.toFixed(3), r.x_m.toFixed(3)]);
      }
      const csv = [headers, ...rows].map(row => row.join(",")).join("\n");
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "motion4_data.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    function init(){
      prepKinematics();
      buildTicks();
      setCenterX(xAt(-0.5));
      tOut.textContent = formatTime(-0.5);
      vOut.textContent = formatVel(vAt(-0.5));
      toggleButtons('idle');
    }

    window.addEventListener('resize', () => { buildTicks(); prepKinematics(); });

    init();
  </script>
</body>
</html>
