<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion 5</title>
  <style>
    :root{
      --track-h: 600px;
      --ball-d: 28px;
      --tick-step: 10px;
      --major-step: 100px;
      --panel-h: 45vh; /* data panel height */
    }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b0c10; color:#eaf0f7}
    body.panel-open { padding-bottom: var(--panel-h); }

    header{padding:16px 20px; border-bottom:1px solid #222; display:flex; gap:12px; align-items:end; flex-wrap:wrap}
    header h1{font-size:1.1rem; margin:0; letter-spacing:.2px; color:#cfe4ff}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{background:#11161d; color:#eaf0f7; border:1px solid #2a3542; padding:8px 12px; border-radius:10px; font-size:.95rem; cursor:pointer}
    button:hover{background:#18202a}
    button:disabled{opacity:.5; cursor:not-allowed}
    .readout{margin-left:auto; display:flex; gap:24px; align-items:center; flex-wrap:wrap}
    .chip{background:#0f1722; border:1px solid #253344; padding:6px 10px; border-radius:999px; font-variant-numeric: tabular-nums}

    .stage-wrap{padding:20px}
    .stage{position:relative; height: var(--track-h); border:1px solid #1f2a36; border-radius:16px; background:linear-gradient(180deg,#0e131a,#0b1016); overflow:hidden}

    .label{position:absolute; top:8px; font-size:.9rem; color:#9ab3cc}
    .label.a{left:10px}
    .label.b{right:10px}

    .measure{position:absolute; left:0; right:0; top:40px; height:40px}
    .baseline{position:absolute; left:0; right:0; top:20px; height:2px; background:#2a3542}
    .ticks{position:absolute; left:0; right:0; top:0; height:100%}
    .tick{position:absolute; width:1px; background:#4b5d74; bottom:20px}
    .tick.minor{height:10px}
    .tick.major{height:16px; background:#8fb6dd}
    .tick-label{position:absolute; bottom:0; transform:translateX(-50%); font-size:.75rem; color:#9ab3cc}

    .vruler{position:absolute; top:60px; bottom:0; width:0} /* moved down by 0.6 m (60 px) */
    .vr-line{position:absolute; top:0; bottom:0; width:2px; background:#2a3542}
    .v-tick{position:absolute; height:1px; background:#4b5d74; left:-20px}
    .v-tick.minor{width:10px}
    .v-tick.major{width:16px; background:#8fb6dd}
    .v-label{position:absolute; left: -28px; transform:translateX(-100%); font-size:.75rem; color:#9ab3cc}

    .ball{position:absolute; width:var(--ball-d); height:var(--ball-d); border-radius:50%; background: radial-gradient(circle at 30% 30%, #cfe4ff, #5ea0ff 55%, #2d4f87); box-shadow: 0 10px 20px rgba(94,160,255,.25)}

    /* data panel */
    .data-panel{
      position: fixed; left: 0; right: 0; bottom: 0; height: var(--panel-h);
      background: linear-gradient(180deg,#0e131a,#0a0d12);
      border-top: 1px solid #1f2a36; display: none; grid-template-rows: auto 1fr; z-index: 50;
    }
    .data-panel.show { display: grid; }
    .data-head{display:flex; align-items:center; gap:10px; padding:10px 16px; border-bottom:1px solid #1f2a36; font-size:.95rem; color:#cfe4ff}
    .data-info{margin-left:auto; font-size:.9rem; color:#9ab3cc}
    .data-body{overflow:auto}
    table{ width:100%; border-collapse: collapse; font-variant-numeric: tabular-nums; }
    thead th{ position: sticky; top:0; background:#0f1722; color:#cfe4ff; text-align:left; border-bottom:1px solid #1f2a36; padding:8px 12px; }
    tbody td{ border-bottom:1px solid #15202c; padding:8px 12px; color:#eaf0f7; }
    .spacer{flex:1}

    /* Velocity visibility toggles */
    body.hide-vx .chip.vx { display:none; }
    body.hide-vx th.th-vx, body.hide-vx td.td-vx { display:none; }
    body.hide-vy .chip.vy { display:none; }
    body.hide-vy th.th-vy, body.hide-vy td.td-vy { display:none; }
/* Lock the track width so SPEED is identical on all machines */
.stage {
  width: 1000px;   /* >= 914 px to safely include X_ARC_END (900) + ball radius (~14) */
  margin: 0 auto;  /* center it */
}

/* If a student’s screen is narrower than the fixed width, allow horizontal scroll */
.stage-wrap {
  overflow-x: auto;
}

  </style>
</head>
<body>
  <header>
    <h1>Motion 5</h1>
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="pauseBtn" disabled>Pause</button>
      <button id="resumeBtn" disabled>Resume</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="resetBtn" disabled>Reset</button>
      <button id="tableBtn">Data Table</button>
      <button id="toggleVxBtn">Hide vₓ</button>
      <button id="toggleVyBtn">Hide vᵧ</button>
      <button id="downloadBtn" disabled>Download CSV</button>
    </div>
    <div class="readout">
      <div class="chip">t = <span id="tOut">-0.500</span> s</div>
      <div class="chip">x = <span id="xOut">0.000</span> m</div>
      <div class="chip">y = <span id="yOut">0.000</span> m</div>
      <div class="chip vx">vₓ = <span id="vxOut">0.000</span> m/s</div>
      <div class="chip vy">vᵧ = <span id="vyOut">0.000</span> m/s</div>
    </div>
  </header>

  <div class="stage-wrap">
    <div class="stage" id="stage">
      <div class="measure">
        <div class="baseline" id="baseline"></div>
        <div class="ticks" id="ticks"></div>
      </div>
      <div class="vruler" id="vruler" aria-hidden="true">
        <div class="vr-line" id="vrline"></div>
        <div class="v-ticks" id="vticks"></div>
      </div>
      <div class="ball" id="ball" aria-label="moving ball"></div>
    </div>
  </div>

  <!-- Data panel -->
  <section id="dataPanel" class="data-panel" aria-live="polite">
    <div class="data-head">
      <strong>Data Table</strong>
      <span class="spacer"></span>
      <span id="dataInfo" class="data-info">—</span>
    </div>
    <div class="data-body">
      <table aria-label="time, position and velocity data">
        <thead>
          <tr>
            <th>t (s)</th>
            <th>x (m)</th>
            <th>y (m)</th>
            <th class="th-vx">vₓ (m/s)</th>
            <th class="th-vy">vᵧ (m/s)</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
  </section>

  <div class="footer">
    <div class="note">Describe and quantify the motion of the ball</div>
  </div>

  <script>
    const stage   = document.getElementById('stage');
    const ball    = document.getElementById('ball');
    const ticksEl = document.getElementById('ticks');

    const startBtn  = document.getElementById('startBtn');
    const pauseBtn  = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const stopBtn   = document.getElementById('stopBtn');
    const resetBtn  = document.getElementById('resetBtn');

    const tableBtn     = document.getElementById('tableBtn');
    const toggleVxBtn  = document.getElementById('toggleVxBtn');
    const toggleVyBtn  = document.getElementById('toggleVyBtn');
    const downloadBtn  = document.getElementById('downloadBtn');

    const dataPanel = document.getElementById('dataPanel');
    const dataBody  = document.getElementById('dataBody');
    const dataInfo  = document.getElementById('dataInfo');

    const tOut  = document.getElementById('tOut');
    const xOut  = document.getElementById('xOut');
    const yOut  = document.getElementById('yOut');
    const vxOut = document.getElementById('vxOut');
    const vyOut = document.getElementById('vyOut');

    const R = 100;
    const L1 = 800;
    const L2 = Math.PI * R / 2;
    const X_ARC_START = 800;
    const X_ARC_END   = 900;

    const A_LIKE = 3.25;

    let running = false;
    let paused  = false;
    let startTime = 0;
    let elapsed = -0.5; // start at -0.50 so t=0 crossing happens after the lead-in
    let rafId = null;

    let ballOffset;
    let y0;
    let SPEED;

    // Data table state
    let tableEnabled   = false;
    let tableEndTime   = 0;
    let tableDt        = 0;
    let nextSampleTime = 0;
    let dataRows       = [];

    // Velocity visibility
    let showVx = true;
    let showVy = true;

    function buildTicks(){
      const minor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tick-step')) || 10;
      const major = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--major-step')) || 100;
      const width = stage.clientWidth;
      ticksEl.innerHTML = '';
      for(let x=0; x<=width; x+=minor){
        const isMajor = (x % major === 0);
        const tick = document.createElement('div');
        tick.className = 'tick ' + (isMajor ? 'major' : 'minor');
        tick.style.left = x + 'px';
        ticksEl.appendChild(tick);
        if(isMajor){
          const label = document.createElement('div');
          label.className = 'tick-label';
          label.textContent = (x/major).toString();
          label.style.left = x + 'px';
          ticksEl.appendChild(label);
        }
      }
    }

    function buildVerticalRuler(){
      const vruler = document.getElementById('vruler');
      const vrline = document.getElementById('vrline');
      const vticks = document.getElementById('vticks');
      const major = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--major-step')) || 100;
      const minor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tick-step')) || 10;

      vruler.style.left = X_ARC_END + 'px';
      vrline.style.left = '-1px';

      vticks.innerHTML = '';
      const height = stage.clientHeight;
      for(let y=0; y<=height; y+=minor){
        const isMajor = (y % major === 0);
        const tick = document.createElement('div');
        tick.className = 'v-tick ' + (isMajor ? 'major' : 'minor');
        tick.style.top = y + 'px';
        vticks.appendChild(tick);
        if(isMajor){
          const label = document.createElement('div');
          label.className = 'v-label';
          label.style.top = (y - 6) + 'px';
          label.textContent = (y/major).toString();
          vticks.appendChild(label);
        }
      }
    }

    // --- Formatting (3 dp) ---
    function formatTime(sec){ return (Math.round(sec * 1000) / 1000).toFixed(3); }
    function fmtMeters(px){ return (px/100).toFixed(3); }
    function fmtMps(pxPerS){ return (pxPerS/100).toFixed(3); }

    function setCenter(x, y){
      ball.style.transform = `translate(${x - ballOffset}px, ${y - ballOffset}px)`;
      xOut.textContent = fmtMeters(x);
      yOut.textContent = fmtMeters(y - y0); // relative to baseline as y=0
    }

    function inferSpeedLikeOriginal(){
      const xB = stage.clientWidth - ballOffset;
      const v0 = Math.sqrt(Math.max(0, 2 * A_LIKE * xB));
      return Math.max(60, Math.min(v0, 600));
    }

    function prep(){
      ballOffset = parseFloat(getComputedStyle(ball).width)/2;
      const measureEl = document.querySelector('.measure');
      y0 = measureEl.offsetTop + 21;
      SPEED = inferSpeedLikeOriginal();
    }

    // Kinematics along path length s
    function positionFromS(s){
      if(s < L1){
        return { x: s, y: y0 };
      }
      const s2 = s - L1;
      if(s2 <= L2){
        const theta = -Math.PI/2 + (s2 / R);
        const Cx = X_ARC_START;
        const Cy = y0 + R;
        const x = Cx + R * Math.cos(theta);
        const y = Cy + R * Math.sin(theta);
        return { x, y, theta };
      }
      const d = s2 - L2;
      return { x: X_ARC_END, y: y0 + R + d };
    }

    function velocityFromS(s){
      if(s < L1){
        return { vx: SPEED, vy: 0 };
      }
      const s2 = s - L1;
      if(s2 <= L2){
        const theta = -Math.PI/2 + (s2 / R);
        // unit tangent on circle is (-sinθ, cosθ)
        return { vx: -SPEED * Math.sin(theta), vy: SPEED * Math.cos(theta) };
      }
      return { vx: 0, vy: SPEED };
    }

    function showPanel(){
      dataPanel.classList.add('show');
      document.body.classList.add('panel-open');
    }
    function clearTable(){
      dataRows = [];
      dataBody.innerHTML = '';
      downloadBtn.disabled = true;
    }
    function appendRow(t, xPx, yPx, vxPxS, vyPxS){
      const tr = document.createElement('tr');
      const tdT  = document.createElement('td');
      const tdX  = document.createElement('td');
      const tdY  = document.createElement('td');
      const tdVx = document.createElement('td');
      const tdVy = document.createElement('td');
      tdT.textContent  = formatTime(t);
      tdX.textContent  = fmtMeters(xPx);
      tdY.textContent  = fmtMeters(yPx - y0);
      tdVx.textContent = fmtMps(vxPxS);
      tdVy.textContent = fmtMps(vyPxS);
      tdVx.className = 'td-vx';
      tdVy.className = 'td-vy';
      tr.append(tdT, tdX, tdY, tdVx, tdVy);
      dataBody.appendChild(tr);
      dataRows.push({ t, x_m: xPx/100, y_m: (yPx - y0)/100, vx_mps: vxPxS/100, vy_mps: vyPxS/100 });
      downloadBtn.disabled = dataRows.length === 0;
    }

    function applyVelToggles(){
      document.body.classList.toggle('hide-vx', !showVx);
      document.body.classList.toggle('hide-vy', !showVy);
      toggleVxBtn.textContent = showVx ? 'Hide vₓ' : 'Show vₓ';
      toggleVyBtn.textContent = showVy ? 'Hide vᵧ' : 'Show vᵧ';
    }

    function step(now){
      if(!running){ return; }
      if(paused){ rafId = requestAnimationFrame(step); return; }

      const t = (now - startTime) / 1000 + elapsed;
      const s = SPEED * t;
      const {x, y} = positionFromS(s);
      const {vx, vy} = velocityFromS(s);

      setCenter(x, y);
      tOut.textContent  = formatTime(t);
      vxOut.textContent = fmtMps(vx);
      vyOut.textContent = fmtMps(vy);

      // Data table sampling (from t = 0 to tableEndTime)
      if(tableEnabled){
        const effT = Math.max(0, t);
        while(nextSampleTime <= tableEndTime + 1e-9 && effT + 1e-9 >= nextSampleTime){
          const ss = SPEED * nextSampleTime;
          const p  = positionFromS(ss);
          const v  = velocityFromS(ss);
          appendRow(nextSampleTime, p.x, p.y, v.vx, v.vy);
          nextSampleTime = +(nextSampleTime + tableDt).toFixed(10); // reduce FP drift
        }
        if(effT >= tableEndTime - 1e-9){
          // Snap & pause at exact end time
          const snapT = tableEndTime;
          const ss = SPEED * snapT;
          const p  = positionFromS(ss);
          const v  = velocityFromS(ss);
          const last = dataRows[dataRows.length - 1];
          if(!last || Math.abs(last.t - snapT) > 1e-6){
            appendRow(snapT, p.x, p.y, v.vx, v.vy);
          }
          setCenter(p.x, p.y);
          tOut.textContent  = formatTime(snapT);
          vxOut.textContent = fmtMps(v.vx);
          vyOut.textContent = fmtMps(v.vy);
          elapsed = snapT;
          paused = true;
          toggleButtons('paused');
          rafId = requestAnimationFrame(step);
          return;
        }
      }

      rafId = requestAnimationFrame(step);
    }

    function toggleButtons(state){
      if(state === 'idle'){
        startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = true;
      } else if(state === 'running'){
        startBtn.disabled = true; pauseBtn.disabled = false; resumeBtn.disabled = true; stopBtn.disabled = false; resetBtn.disabled = false;
      } else if(state === 'paused'){
        startBtn.disabled = true; pauseBtn.disabled = true; resumeBtn.disabled = false; stopBtn.disabled = false; resetBtn.disabled = false;
      } else if(state === 'stopped'){
        startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true; resetBtn.disabled = false;
      }
    }

    // Controls
    startBtn.addEventListener('click', () => {
      cancelAnimationFrame(rafId);
      prep();
      buildVerticalRuler();
      running = true; paused = false; elapsed = -0.5;
      const s0 = SPEED * (-0.5);
      const p0 = positionFromS(s0);
      const v0 = velocityFromS(s0);
      setCenter(p0.x, p0.y);
      tOut.textContent  = formatTime(-0.5);
      vxOut.textContent = fmtMps(v0.vx);
      vyOut.textContent = fmtMps(v0.vy);

      if(tableEnabled){
        clearTable();
        nextSampleTime = 0; // sample from t=0
      }

      startTime = performance.now();
      toggleButtons('running');
      rafId = requestAnimationFrame(step);
    });

    pauseBtn.addEventListener('click', () => {
      if(!running || paused) return;
      const tNow = performance.now();
      elapsed += (tNow - startTime) / 1000;
      paused = true;
      toggleButtons('paused');
    });

    resumeBtn.addEventListener('click', () => {
      if(!running || !paused) return;
      if(tableEnabled && elapsed >= tableEndTime - 1e-9){ return; } // don't resume past the table end
      paused = false;
      startTime = performance.now();
      toggleButtons('running');
      rafId = requestAnimationFrame(step);
    });

    stopBtn.addEventListener('click', () => {
      if(!running) return;
      running = false; paused = false;
      toggleButtons('stopped');
      cancelAnimationFrame(rafId);
    });

    resetBtn.addEventListener('click', () => {
      running = false; paused = false; elapsed = -0.5;
      cancelAnimationFrame(rafId);
      prep();
      buildVerticalRuler();
      const s0 = SPEED * (-0.5);
      const p0 = positionFromS(s0);
      const v0 = velocityFromS(s0);
      setCenter(p0.x, p0.y);
      tOut.textContent  = formatTime(-0.5);
      vxOut.textContent = fmtMps(v0.vx);
      vyOut.textContent = fmtMps(v0.vy);
      toggleButtons('idle');
      if(tableEnabled){ clearTable(); nextSampleTime = 0; }
    });

    // Data Table button → prompt for end-time & increment (relative to t=0)
    tableBtn.addEventListener('click', () => {
      let T  = prompt("End time from A (s):", "5");
      if(T === null) return;
      let dt = prompt("Time increment Δt (s):", "0.2");
      if(dt === null) return;

      T  = Number(T);
      dt = Number(dt);

      if(!(isFinite(T) && T > 0)){
        alert("Please enter a positive end time.");
        return;
      }
      if(!(isFinite(dt) && dt > 0 && dt <= T)){
        alert("Please enter a positive increment ≤ end time.");
        return;
      }

      tableEnabled   = true;
      tableEndTime   = T;
      tableDt        = dt;
      nextSampleTime = 0;
      clearTable();
      showPanel();
      dataInfo.textContent = `End: ${formatTime(tableEndTime)} s, Δt: ${formatTime(tableDt)} s (from t = 0 at A)`;

      if(running){
        // restart to align sampling from t=0 cleanly
        running = false; paused = false; elapsed = -0.5;
        cancelAnimationFrame(rafId);
        const s0 = SPEED * (-0.5);
        const p0 = positionFromS(s0);
        const v0 = velocityFromS(s0);
        setCenter(p0.x, p0.y);
        tOut.textContent  = formatTime(-0.5);
        vxOut.textContent = fmtMps(v0.vx);
        vyOut.textContent = fmtMps(v0.vy);
        running = true; paused = false;
        startTime = performance.now();
        toggleButtons('running');
        rafId = requestAnimationFrame(step);
      }
    });

    // Velocity toggles (affect visibility only; CSV always includes vx & vy)
    toggleVxBtn.addEventListener('click', () => {
      showVx = !showVx; applyVelToggles();
    });
    toggleVyBtn.addEventListener('click', () => {
      showVy = !showVy; applyVelToggles();
    });
    function applyVelToggles(){
      document.body.classList.toggle('hide-vx', !showVx);
      document.body.classList.toggle('hide-vy', !showVy);
      toggleVxBtn.textContent = showVx ? 'Hide vₓ' : 'Show vₓ';
      toggleVyBtn.textContent = showVy ? 'Hide vᵧ' : 'Show vᵧ';
    }
    applyVelToggles();

    // CSV download (always includes vx & vy; 3 dp)
    downloadBtn.addEventListener('click', () => {
      if(dataRows.length === 0) return;
      const headers = ["time (s)","x (m)","y (m)","v_x (m/s)","v_y (m/s)"];
      const rows = dataRows.map(r => [r.t.toFixed(3), r.x_m.toFixed(3), r.y_m.toFixed(3), r.vx_mps.toFixed(3), r.vy_mps.toFixed(3)]);
      const csv = [headers, ...rows].map(row => row.join(",")).join("\n");
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "motion5_data.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Build rulers & init
    function init(){
      prep();
      buildTicks();
      buildVerticalRuler();
      const s0 = SPEED * (-0.5);
      const p0 = positionFromS(s0);
      const v0 = velocityFromS(s0);
      setCenter(p0.x, p0.y);
      tOut.textContent  = formatTime(-0.5);
      vxOut.textContent = fmtMps(v0.vx);
      vyOut.textContent = fmtMps(v0.vy);
      toggleButtons('idle');
    }

    window.addEventListener('resize', () => { buildTicks(); buildVerticalRuler(); prep(); });

    init();
  </script>
</body>
</html>
